{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ -->
        <nav class="col-md-3 col-lg-2 d-md-block bg-dark sidebar collapse">
            <div class="position-sticky pt-3">
                <div class="sidebar-header text-center py-3">
                    <h4 class="text-white">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ</h4>
                </div>
                
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="{{ url_for('dashboard') }}">
                            ğŸ  Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="loadAccounts()">
                            ğŸ“’ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
                        </a>
                    </li>
                    <li class="nav-item">
                        <a                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
            <div class="row mt-4">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">ğŸ“ˆ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</h5>
                        </div>
                        <div class="card-body">
                            <div id="monthlyChart" style="height: 300px;">
                                <canvas id="performanceChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">ğŸ“Š ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h5>
                        </div>
                        <div class="card-body">
                            <div id="accountsChart" style="height: 300px;">
                                <canvas id="accountsDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© -->
            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">â° Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©</h5>
                    <span class="badge bg-danger" id="dueInvoicesCount">0</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="dueInvoicesTable">
                            <thead>
                                <tr>
                                    <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                                    <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                    <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th>
                                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ø¨Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ÙˆØ§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">ğŸ”” Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</h5>
                        </div>
                        <div class="card-body">
                            <div class="list-group" id="alertsList">
                                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ø¨Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">ğŸ“‹ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</h5>
                        </div>
                        <div class="card-body">
                            <div class="list-group" id="tasksList">
                                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ø¨Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ø­Ø±ÙƒØ© -->
<div class="modal fade" id="addTransactionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">â• Ø¥Ø¶Ø§ÙØ© Ø­Ø±ÙƒØ© Ø¬Ø¯ÙŠØ¯Ø©</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="transactionForm">
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                        <input type="date" class="form-control" id="transactionDate" required 
                               value="{{ date.today().strftime('%Y-%m-%d') }}">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„ÙˆØµÙ</label>
                        <input type="text" class="form-control" id="transactionDescription" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„Ø­Ø³Ø§Ø¨</label>
                        <select class="form-control" id="transactionAccount" required>
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø³Ø§Ø¨</option>
                            <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ø¨Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
                        </select>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Ø§Ù„Ù…Ø¯ÙŠÙ†</label>
                                <input type="number" class="form-control" id="transactionDebit" 
                                       step="0.01" min="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Ø§Ù„Ø¯Ø§Ø¦Ù†</label>
                                <input type="number" class="form-control" id="transactionCredit" 
                                       step="0.01" min="0">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" class="btn btn-primary" onclick="saveTransaction()">Ø­ÙØ¸</button>
            </div>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ -->
<div class="modal fade" id="addCustomerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ğŸ‘¥ Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="customerForm">
                    <div class="mb-3">
                        <label class="form-label">ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                        <input type="text" class="form-control" id="customerCode" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                        <input type="text" class="form-control" id="customerName" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„Ù‡Ø§ØªÙ</label>
                        <input type="tel" class="form-control" id="customerPhone">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                        <input type="email" class="form-control" id="customerEmail">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ</label>
                        <input type="number" class="form-control" id="customerBalance" 
                               step="0.01" value="0">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" class="btn btn-success" onclick="saveCustomer()">Ø­ÙØ¸</button>
            </div>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
<div class="modal fade" id="reportsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5>ğŸ’° Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø¹Ù…ÙˆÙ…ÙŠØ©</h5>
                                <p>Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆÙ‚Ù Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
                                <button class="btn btn-outline-primary" onclick="generateBalanceSheet()">
                                    Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5>ğŸ“ˆ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„</h5>
                                <p>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª</p>
                                <button class="btn btn-outline-success" onclick="generateIncomeStatement()">
                                    Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5>âš–ï¸ Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h5>
                                <p>Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</p>
                                <button class="btn btn-outline-warning" onclick="generateTrialBalance()">
                                    Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5>ğŸ‘¥ ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„</h5>
                                <p>Ø­Ø±ÙƒØ§Øª Ø¹Ù…ÙŠÙ„ Ù…Ø¹ÙŠÙ†</p>
                                <button class="btn btn-outline-info" onclick="generateCustomerStatement()">
                                    Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="reportResult" class="mt-3" style="display: none;">
                    <!-- Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù‡Ù†Ø§ -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
let accounts = [];
let customers = [];
let monthlyData = [];

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    loadAccounts();
    loadCustomers();
    loadDashboardStats();
    loadMonthlyData();
    loadDueInvoices();
    loadAlerts();
    loadTasks();
});

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
async function loadAccounts() {
    try {
        const response = await fetch('/api/accounts');
        accounts = await response.json();
        
        // ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
        const accountSelect = document.getElementById('transactionAccount');
        accountSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø³Ø§Ø¨</option>';
        
        accounts.forEach(account => {
            const option = document.createElement('option');
            option.value = account.id;
            option.textContent = `${account.code} - ${account.name}`;
            accountSelect.appendChild(option);
        });
        
        // Ø±Ø³Ù… Ù…Ø®Ø·Ø· ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
        renderAccountsChart();
    } catch (error) {
        console.error('Error loading accounts:', error);
    }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
async function loadCustomers() {
    try {
        const response = await fetch('/api/customers');
        customers = await response.json();
    } catch (error) {
        console.error('Error loading customers:', error);
    }
}

// ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
async function loadDashboardStats() {
    try {
        const response = await fetch('/api/dashboard/stats');
        const stats = await response.json();
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        updateStatsCards(stats);
    } catch (error) {
        console.error('Error loading dashboard stats:', error);
    }
}

// ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø±
async function loadMonthlyData() {
    try {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        
        const response = await fetch(`/api/transactions/monthly?start=${formatDate(firstDay)}&end=${formatDate(lastDay)}`);
        monthlyData = await response.json();
        
        // Ø±Ø³Ù… Ù…Ø®Ø·Ø· Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø±ÙŠ
        renderPerformanceChart();
    } catch (error) {
        console.error('Error loading monthly data:', error);
    }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©
async function loadDueInvoices() {
    try {
        const response = await fetch('/api/invoices/due');
        const dueInvoices = await response.json();
        
        updateDueInvoicesTable(dueInvoices);
    } catch (error) {
        console.error('Error loading due invoices:', error);
    }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
async function loadAlerts() {
    try {
        const response = await fetch('/api/alerts');
        const alerts = await response.json();
        
        updateAlertsList(alerts);
    } catch (error) {
        console.error('Error loading alerts:', error);
    }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…
async function loadTasks() {
    try {
        const response = await fetch('/api/tasks');
        const tasks = await response.json();
        
        updateTasksList(tasks);
    } catch (error) {
        console.error('Error loading tasks:', error);
    }
}

// ØªØ­Ø¯ÙŠØ« Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
function updateStatsCards(stats) {
    // ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø§ØµØ± HTML Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ù‡Ù†Ø§
    console.log('Dashboard stats:', stats);
}

// ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©
function updateDueInvoicesTable(invoices) {
    const tableBody = document.querySelector('#dueInvoicesTable tbody');
    const countElement = document.getElementById('dueInvoicesCount');
    
    tableBody.innerHTML = '';
    countElement.textContent = invoices.length;
    
    if (invoices.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted">
                    Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù…Ø³ØªØ­Ù‚Ø©
                </td>
            </tr>
        `;
        return;
    }
    
    invoices.forEach(invoice => {
        const row = document.createElement('tr');
        
        // ØªØ­Ø¯ÙŠØ¯ Ù„ÙˆÙ† Ø§Ù„Ø­Ø§Ù„Ø©
        let statusBadge = '';
        if (invoice.status === 'overdue') {
            statusBadge = '<span class="badge bg-danger">Ù…ØªØ£Ø®Ø±Ø©</span>';
        } else if (invoice.status === 'due_soon') {
            statusBadge = '<span class="badge bg-warning">Ù‚Ø±ÙŠØ¨ Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</span>';
        } else {
            statusBadge = '<span class="badge bg-info">' + invoice.status + '</span>';
        }
        
        row.innerHTML = `
            <td>${invoice.invoice_number}</td>
            <td>${invoice.customer_name}</td>
            <td>${formatCurrency(invoice.amount)}</td>
            <td>${invoice.due_date}</td>
            <td>${statusBadge}</td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="viewInvoice(${invoice.id})">
                    Ø¹Ø±Ø¶
                </button>
                <button class="btn btn-sm btn-success" onclick="recordPayment(${invoice.id})">
                    ØªØ³Ø¯ÙŠØ¯
                </button>
            </td>
        `;
        
        tableBody.appendChild(row);
    });
}

// ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
function updateAlertsList(alerts) {
    const alertsList = document.getElementById('alertsList');
    alertsList.innerHTML = '';
    
    if (alerts.length === 0) {
        alertsList.innerHTML = `
            <div class="alert alert-info">
                Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹
            </div>
        `;
        return;
    }
    
    alerts.forEach(alert => {
        const alertItem = document.createElement('div');
        alertItem.className = 'list-group-item';
        
        let alertIcon = 'ğŸ””';
        if (alert.type === 'warning') alertIcon = 'âš ï¸';
        if (alert.type === 'danger') alertIcon = 'ğŸš¨';
        if (alert.type === 'success') alertIcon = 'âœ…';
        
        alertItem.innerHTML = `
            <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">${alertIcon} ${alert.title}</h6>
                <small>${alert.time}</small>
            </div>
            <p class="mb-1">${alert.message}</p>
            ${alert.action ? `<small><a href="#" onclick="${alert.action}">${alert.action_text}</a></small>` : ''}
        `;
        
        alertsList.appendChild(alertItem);
    });
}

// ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù…
function updateTasksList(tasks) {
    const tasksList = document.getElementById('tasksList');
    tasksList.innerHTML = '';
    
    if (tasks.length === 0) {
        tasksList.innerHTML = `
            <div class="alert alert-info">
                Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø­Ø§Ù„ÙŠØ§Ù‹
            </div>
        `;
        return;
    }
    
    tasks.forEach(task => {
        const taskItem = document.createElement('div');
        taskItem.className = 'list-group-item';
        
        let taskIcon = 'ğŸ“‹';
        if (task.priority === 'high') taskIcon = 'ğŸ”¥';
        if (task.priority === 'medium') taskIcon = 'âš¡';
        
        taskItem.innerHTML = `
            <div class="d-flex w-100 justify-content-between align-items-center">
                <div>
                    <h6 class="mb-1">${taskIcon} ${task.title}</h6>
                    <p class="mb-1">${task.description}</p>
                    <small class="text-muted">${task.due_date}</small>
                </div>
                <div>
                    <button class="btn btn-sm btn-success" onclick="completeTask(${task.id})">
                        âœ“
                    </button>
                </div>
            </div>
        `;
        
        tasksList.appendChild(taskItem);
    });
}

// Ø±Ø³Ù… Ù…Ø®Ø·Ø· Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø±ÙŠ
function renderPerformanceChart() {
    const ctx = document.getElementById('performanceChart').getContext('2d');
    
    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙŠÙˆÙ…
    const dailyData = {};
    monthlyData.forEach(transaction => {
        const date = transaction.date;
        if (!dailyData[date]) {
            dailyData[date] = { debit: 0, credit: 0 };
        }
        dailyData[date].debit += transaction.debit;
        dailyData[date].credit += transaction.credit;
    });
    
    const dates = Object.keys(dailyData).sort();
    const debits = dates.map(date => dailyData[date].debit);
    const credits = dates.map(date => dailyData[date].credit);
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [
                {
                    label: 'Ù…Ø¯ÙŠÙ†',
                    data: debits,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                },
                {
                    label: 'Ø¯Ø§Ø¦Ù†',
                    data: credits,
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    tension: 0.1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Ø±Ø³Ù… Ù…Ø®Ø·Ø· ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
function renderAccountsChart() {
    const ctx = document.getElementById('accountsDistributionChart').getContext('2d');
    
    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
    const accountTypes = {};
    accounts.forEach(account => {
        if (!accountTypes[account.type]) {
            accountTypes[account.type] = 0;
        }
        accountTypes[account.type] += account.balance;
    });
    
    const labels = Object.keys(accountTypes);
    const data = Object.values(accountTypes);
    const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                }
            }
        }
    });
}

// Ø¹Ø±Ø¶ Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ø­Ø±ÙƒØ©
function showAddTransaction() {
    const modal = new bootstrap.Modal(document.getElementById('addTransactionModal'));
    modal.show();
}

// Ø­ÙØ¸ Ø§Ù„Ø­Ø±ÙƒØ©
async function saveTransaction() {
    const debit = parseFloat(document.getElementById('transactionDebit').value) || 0;
    const credit = parseFloat(document.getElementById('transactionCredit').value) || 0;
    
    if (debit === 0 && credit === 0) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ù„Ù„Ù…Ø¯ÙŠÙ† Ø£Ùˆ Ø§Ù„Ø¯Ø§Ø¦Ù†');
        return;
    }
    
    const transaction = {
        date: document.getElementById('transactionDate').value,
        description: document.getElementById('transactionDescription').value,
        account_id: document.getElementById('transactionAccount').value,
        debit: debit,
        credit: credit
    };
    
    try {
        const response = await fetch('/api/transactions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(transaction)
        });
        
        if (response.ok) {
            alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­');
            bootstrap.Modal.getInstance(document.getElementById('addTransactionModal')).hide();
            location.reload();
        } else {
            throw new Error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø­Ø±ÙƒØ©');
        }
    } catch (error) {
        console.error('Error saving transaction:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø­Ø±ÙƒØ©');
    }
}

// Ø¹Ø±Ø¶ Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„
function showAddCustomer() {
    const modal = new bootstrap.Modal(document.getElementById('addCustomerModal'));
    modal.show();
}

// Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„
async function saveCustomer() {
    const customer = {
        code: document.getElementById('customerCode').value,
        name: document.getElementById('customerName').value,
        phone: document.getElementById('customerPhone').value,
        email: document.getElementById('customerEmail').value,
        balance: parseFloat(document.getElementById('customerBalance').value) || 0
    };
    
    try {
        const response = await fetch('/api/customers', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(customer)
        });
        
        if (response.ok) {
            alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
            bootstrap.Modal.getInstance(document.getElementById('addCustomerModal')).hide();
            loadCustomers();
        } else {
            throw new Error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„');
        }
    } catch (error) {
        console.error('Error saving customer:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„');
    }
}

// Ø¹Ø±Ø¶ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
function showReports() {
    const modal = new bootstrap.Modal(document.getElementById('reportsModal'));
    modal.show();
}

// ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø¹Ù…ÙˆÙ…ÙŠØ©
async function generateBalanceSheet() {
    try {
        const response = await fetch('/api/reports/balance-sheet');
        const report = await response.json();
        
        displayReport('Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø¹Ù…ÙˆÙ…ÙŠØ©', report);
    } catch (error) {
        console.error('Error generating balance sheet:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
    }
}

// ØªÙˆÙ„ÙŠØ¯ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„
async function generateIncomeStatement() {
    try {
        const response = await fetch('/api/reports/income-statement');
        const report = await response.json();
        
        displayReport('Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„', report);
    } catch (error) {
        console.error('Error generating income statement:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
    }
}

// ØªÙˆÙ„ÙŠØ¯ Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
async function generateTrialBalance() {
    try {
        const response = await fetch('/api/reports/trial-balance');
        const report = await response.json();
        
        displayReport('Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©', report);
    } catch (error) {
        console.error('Error generating trial balance:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
    }
}

// ØªÙˆÙ„ÙŠØ¯ ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„
function generateCustomerStatement() {
    alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù…ÙŠÙ„ Ù„Ø¹Ø±Ø¶ ÙƒØ´Ù Ø­Ø³Ø§Ø¨Ù‡');
    // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù…ÙŠÙ„ Ø«Ù… Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ±Ù‡
}

// Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
function displayReport(title, data) {
    const reportResult = document.getElementById('reportResult');
    
    // Ø¨Ù†Ø§Ø¡ HTML Ù„Ù„ØªÙ‚Ø±ÙŠØ±
    let html = `
        <div class="card">
            <div class="card-header">
                <h5>${title}</h5>
            </div>
            <div class="card-body">
                <pre style="white-space: pre-wrap;">${JSON.stringify(data, null, 2)}</pre>
            </div>
        </div>
    `;
    
    reportResult.innerHTML = html;
    reportResult.style.display = 'block';
}

// ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø©
function formatDate(date) {
    return date.toISOString().split('T')[0];
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('ar-SA', {
        style: 'currency',
        currency: 'SAR'
    }).format(amount);
}

function viewInvoice(invoiceId) {
    window.open(`/invoice/${invoiceId}`, '_blank');
}

function recordPayment(invoiceId) {
    alert(`ØªØ³Ø¯ÙŠØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ${invoiceId} - Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±`);
}

function completeTask(taskId) {
    alert(`Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø© ${taskId} - Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±`);
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
setInterval(() => {
    loadDashboardStats();
    loadDueInvoices();
    loadAlerts();
}, 60000);

// Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ±Ø§Øª CSS Ø¥Ø¶Ø§ÙÙŠØ©
const style = document.createElement('style');
style.textContent = `
    .card {
        transition: transform 0.3s;
    }
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }
    .list-group-item {
        transition: background-color 0.3s;
    }
    .list-group-item:hover {
        background-color: #f8f9fa;
    }
    .badge {
        font-size: 0.8em;
    }
`;
document.head.appendChild(style);
</script>

{% endblock %}
